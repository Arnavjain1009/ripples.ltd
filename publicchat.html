<!DOCTYPE html>
<html>
<head>
  <title>whattschat</title>
  <link rel="icon" type="image/svg+xml" href="https://www.shutterstock.com/image-vector/initial-letter-number-logo-r-600w-621114830.jpg" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    /* CSS styles here */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f2f2f2;
    }

    h1 {
      text-align: center;
      padding: 4vw;
      background-color: #075e54;
      color: #ffffff;
      margin: 0;
    }

    #messages-container {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;

      box-shadow: 0px -1px 10px rgba(0, 0, 0, 0.3);
    }

    #messages {
      border: 1px solid #cccccc;
      padding: 2vh;
      height: 65vh;
      overflow-y: scroll;
      background-color: #f2f2f2;
    }

    #message-input-container {
      display: flex;
      align-items: center;
      margin-top: 2vh;
    }

    #message-input {
      flex: 1;
      padding: 2vh;
      border: 1px solid #cccccc;
      font-size: 3vw;
    }

    #send-button {
      padding: 2vh;
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      width: 20vw;
      height: 7vh;
    }

    /* Updated styles for message bubbles */
    .message-bubble {
      border-radius: 8px;
      margin-bottom: 2vh;
      word-wrap: break-word;
      max-width: 80%;
      background-color: lightblue;
    }
    .message-bubble2 {
      border-radius: 8px;
      margin-bottom: 2vh;
      word-wrap: break-word;
      max-width: 80%;
      background-color: lightgrey;
    }

    .my-message {
      color: #075e54;
      align-self: flex-end;
      text-align: right;
    }

    .other-message {
      color: #000000;
      align-self: flex-start;
      text-align: left;
    }

    /* Added styles for message container */
    .message-container {
      display: flex;
      justify-content: flex-start;
    }

    .my-message .message-container {
      justify-content: flex-end;
    }

    /* Added styles for non-phone devices */
    @media (min-width: 768px) {
      .message-bubble,
      .message-bubble2 {
        padding: 1vh;
        line-height: 1.5;
      }
    }
  </style>
</head>
<body>
  <h1>whattschat</h1>
  <div id="messages-container">
    <div id="messages"></div>
    <div id="message-input-container">
      <input type="text" id="message-input" placeholder="Type a message...">
      <button id="send-button">Send</button>
    </div>
  </div>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script>
    // JavaScript code here (same as before)
    // Initialize Firebase
    var firebaseConfig = {
      // Your Firebase config here
      apiKey: "AIzaSyBP5fSB_kiakv0r-WMo7BkP2Ik70c26tT0",
  authDomain: "whattschat-f522c.firebaseapp.com",
  databaseURL: "https://whattschat-f522c-default-rtdb.firebaseio.com",
  projectId: "whattschat-f522c",
  storageBucket: "whattschat-f522c.appspot.com",
  messagingSenderId: "746097682908",
  appId: "1:746097682908:web:51a0278320ad4af5774719",
};
    firebase.initializeApp(firebaseConfig);

    // Get a reference to the database service
    var database = firebase.database();
    var url_string = window.location.href;
    var url = new URL(url_string);
    var myuserid = url.searchParams.get("userid");
    var mysecretkey = url.searchParams.get("secretkey");
    var selecteduserid = url.searchParams.get("selecteduserid");
    var passwordmatched = false;

    // Now connect to the database and link to the user; fetch secret key for the given userid
    MyValRef = database.ref("/users/" + myuserid);

    MyValRef.orderByValue().on("value", function (snapshot) {
      snapshot.forEach(function (data) {
        // Now compare database key with mysecret
        if (mysecretkey == data.val()) {
          passwordmatched = true;
        }
      });

      if (passwordmatched != true) {
        window.location.replace("whattschat/abc.html");
      } else {
        MyValRef.off();
      }
    });

    // Get references to the input and send button
    var messageInput = document.getElementById("message-input");
    var sendButton = document.getElementById("send-button");

    // Get a reference to the messages div
    var messagesDiv = document.getElementById("messages");

    // Add an event listener to the send button
    sendButton.addEventListener("click", function () {
      // Get the current user's ID (you will need to implement your own authentication method)
      var userId = myuserid;
      var messageText = messageInput.value;
      if (messageText.length > 100) {
        alert("Message should not exceed 100 characters");
        return;
      }
      if (messageText.length === 0) {
        alert("Message should not be empty");
        return;
      }

      // Get the message text from the input field
      var messageText = messageInput.value;
      var MsgTime = getCurrentTime();
      var MsgDate = getCurrentDate();

      // Push the message to the database
      database.ref("messages").push({
        selecteduserid: selecteduserid,
        userId: userId,
        message: "[" + userId + "] " + messageText,
        messageDate: MsgDate,
        messageTime: MsgTime
      });

      // Clear the input field
      messageInput.value = "";
    });

    database.ref("messages").on("child_added", function (snapshot) {
      var messageData = snapshot.val();

      var messageElement = document.createElement("div");
      var messageContainer = document.createElement("div"); // Added message container
      var messageBubble = document.createElement("div");
      var messageContent = document.createElement("div");

      messageContainer.classList.add("message-container"); // Added message container class
   
      if (messageData.userId == myuserid && messageData.selecteduserid == selecteduserid ||
          messageData.userId == selecteduserid && messageData.selecteduserid == myuserid) {
        if (messageData.userId == myuserid) {
          messageBubble.classList.add("message-bubble");
          messageElement.classList.add("my-message");
        } else {
          messageBubble.classList.add("message-bubble2");

          messageElement.classList.add("other-message");
        }

        messageElement.appendChild(messageContainer); // Added message container to message element
        messageContainer.appendChild(messageBubble); // Added message bubble to message container
        messageBubble.appendChild(messageContent);

        var messageText = document.createElement("span");
        messageText.textContent = messageData.message;

        var messageTime = document.createElement("span");
        messageTime.textContent = messageData.messageTime;

        messageContent.appendChild(messageText);
        messageContent.appendChild(document.createElement("br"));
        messageContent.appendChild(messageTime);

        messagesDiv.appendChild(messageElement);
        if (!isPhoneDevice()) {
          messagesDiv.appendChild(document.createElement("hr")); // Added horizontal line after each message
        }
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }
    });

    function getCurrentTime() {
      var currentdate = new Date();
      var hours = currentdate.getHours();
      var minutes = currentdate.getMinutes();
      var ampm = hours >= 12 ? "PM" : "AM";
      hours = hours % 12;
      hours = hours ? hours : 12;
      minutes = minutes < 10 ? "0" + minutes : minutes;
      var currentTime = hours + ":" + minutes + " " + ampm;
      return currentTime;
    }

    function getCurrentDate() {
      var currentdate = new Date();
      var month = currentdate.getMonth() + 1;
      var day = currentdate.getDate();
      var year = currentdate.getFullYear();
      var currentDate = day + "/" + month + "/" + year;
      return currentDate;
    }

    function isPhoneDevice() {
      var phoneDeviceWidth = 768; // Adjust the width as per your needs
      return window.innerWidth < phoneDeviceWidth;
    }
  </script>
  <!-- Code injected by live-server -->
  <script>
    // <![CDATA[  <-- For SVG support
    if ('WebSocket' in window) {
      (function () {
        function refreshCSS() {
          var sheets = [].slice.call(document.getElementsByTagName("link"));
          var head = document.getElementsByTagName("head")[0];
          for (var i = 0; i < sheets.length; ++i) {
            var elem = sheets[i];
            var parent = elem.parentElement || head;
            parent.removeChild(elem);
            var rel = elem.rel;
            if (elem.href && typeof rel != "string" || rel.length == 0 || rel.toLowerCase() == "stylesheet") {
              var url = elem.href.replace(/(&|\?)_cacheOverride=\d+/, '');
              elem.href = url + (url.indexOf('?') >= 0 ? '&' : '?') + '_cacheOverride=' + (new Date().valueOf());
            }
            parent.appendChild(elem);
          }
        }
        var protocol = window.location.protocol === 'http:' ? 'ws://' : 'wss://';
        var address = protocol + window.location.host + window.location.pathname + '/ws';
        var socket = new WebSocket(address);
        socket.onmessage = function (msg) {
          if (msg.data == 'reload') window.location.reload();
          else if (msg.data == 'refreshcss') refreshCSS();
        };
        if (sessionStorage && !sessionStorage.getItem('IsThisFirstTime_Log_From_LiveServer')) {
          console.log('Live reload enabled.');
          sessionStorage.setItem('IsThisFirstTime_Log_From_LiveServer', true);
        }
      })();
    } else {
      console.error('Upgrade your browser. This Browser is NOT supported WebSocket for Live-Reloading.');
    }
    // ]]>
  </script>
</body>
</html>
